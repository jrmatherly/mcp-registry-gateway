# Global configuration - these values are passed to all subcharts
global:
  # Domain configuration - update this to your actual domain
  domain: "DOMAIN"

  # Security settings - CHANGE THESE IN PRODUCTION
  secretKey: "aReallyGoodKeyThatShouldBeChanged"

  # Common ingress settings
  ingress:
    className: alb
    tls: true
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302

mongodb-kubernetes:
  operator:
    enableClusterMongoDBRoles: false
    telemetry:
      installClusterRole: false

# MongoDB CE 8.2+ configuration with native vector search
mongodb:
  enabled: true
  name: mongodb  # Name of the MongoDB resource (used for service discovery)
  version: "8.2.0"  # MongoDB version (8.2+ required for native $vectorSearch)
  replicas: 3  # Number of replica set members

  # Authentication
  user: registry  # MongoDB username
  password: CHANGEME  # MongoDB password - CHANGE IN PRODUCTION
  auth:
    enabled: true
    secretName: mongodb-credentials

  # Resource limits for mongod pods
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

  # WiredTiger cache settings
  wiredTiger:
    cacheSizeGB: 1  # Adjust based on container memory

  # Persistence for mongod data
  persistence:
    enabled: true
    size: 50Gi
    storageClass: ""  # Use default storage class

  # Pod disruption budget (enable for production)
  podDisruptionBudget:
    enabled: false
    minAvailable: 2

  # Maximum client connections
  maxConnections: 1000

  # Vector search (mongot) configuration
  vectorSearch:
    enabled: true  # Deploy MongoDBSearch CRD for mongot pods

    # Resource limits for mongot pods
    # Memory sizing: (num_vectors * dimensions * 4 bytes) * 1.25
    resources:
      requests:
        cpu: "500m"
        memory: "2Gi"
      limits:
        cpu: "2"
        memory: "8Gi"

    # Persistence for mongot index data
    persistence:
      enabled: true
      size: 20Gi
      storageClass: ""

    # Pod disruption budget for mongot
    podDisruptionBudget:
      minAvailable: 1

# Keycloak configuration
keycloak:
  image:
    repository: bitnamilegacy/keycloak

  global:
    security:
      allowInsecureImages: true

  postgresql:
    image:
      repository: bitnamilegacy/postgresql

  extraEnvVars:
    - name: KC_PROXY
      value: edge
    - name: KC_PROXY_HEADERS
      value: xforwarded

  ingress:
    enabled: false # We use a custom ingress template that supports global.domain

  # Lifecycle hook to configure realm SSL settings
  lifecycleHooks:
    postStart:
      exec:
        command:
          - "/bin/bash"
          - "-c"
          - |
            (
              echo "PostStart: Waiting for Keycloak to be ready..."
              for i in {1..120}; do
                if curl -sf http://localhost:8080/realms/$KC_SPI_ADMIN_REALM > /dev/null 2>&1; then
                  echo "Keycloak ready after $i attempts"
                  break
                fi
                sleep 5
              done
              sleep 10
              echo "Configuring $KC_SPI_ADMIN_REALM realm..."
              /opt/bitnami/keycloak/bin/kcadm.sh config credentials \
                --config /tmp/kcadm.config \
                --server http://localhost:8080 \
                --realm $KC_SPI_ADMIN_REALM \
                --user $KC_BOOTSTRAP_ADMIN_USERNAME \
                --password $(cat $KC_BOOTSTRAP_ADMIN_PASSWORD_FILE)
              /opt/bitnami/keycloak/bin/kcadm.sh update \
                --config /tmp/kcadm.config \
                realms/$KC_SPI_ADMIN_REALM \
                -s sslRequired=NONE
              echo "âœ“ $KC_SPI_ADMIN_REALM realm configured!"
            ) > /tmp/poststart-config.log 2>&1 &

# Keycloak configuration job
keycloak-configure:
  keycloak:
    realm: mcp-gateway
    adminUser: user
  # authServer.externalUrl will be templated in the subchart using global.domain

# Mongodb configuration job
mongodb-configure:
  enabled: true # Whether to run the MongoDB configuration job
  mongodb:
    # Must match mongodb.name-svc from the MongoDB CRD
    host: "mongodb-svc"
    port: 27017
    database: "mcp_registry"
    namespace: "default"
    # Credentials must match mongodb.user and mongodb.password
    username: "registry"
    password: "CHANGEME"  # Must match mongodb.password - CHANGE IN PRODUCTION
    replica_set: "mongodb"  # Matches mongodb.name from the MongoDB CRD
    use_tls: false
    storage_backend: "mongodb"  # Matches registry.storage.backend

# Registry service configuration
registry:
  # app.secretKey and app.authServerUrl will be templated in the subchart using global values
  app:
    replicas: 1

  # Storage backend configuration
  # Options: "file", "documentdb", "mongodb-ce", "mongodb"
  #   - mongodb: MongoDB CE 8.2+ with native $vectorSearch (recommended for K8s)
  storage:
    backend: "mongodb"
    mongodb:
      # Service name matches mongodb.name from the MongoDB CRD
      # Format: <mongodb.name>-svc.<namespace>.svc.cluster.local
      host: "mongodb-svc"
      port: 27017
      database: "mcp_registry"
      # Credentials must match mongodb.user and mongodb.password above
      username: "registry"
      password: "CHANGEME"  # Must match mongodb.password - CHANGE IN PRODUCTION
      useTls: false
      directConnection: false
      namespace: "default"
    vectorSearch:
      enabled: true
      indexName: "vector_index"
      similarityMetric: "cosine"
      numCandidatesMultiplier: 10

  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302

# Auth server configuration
auth-server:
  # app.secretKey, app.externalUrl, app.sessionCookieDomain will be templated using global values
  app:
    replicas: 1
  keycloak:
    enabled: true
    realm: mcp-gateway
    # externalUrl will be templated in the subchart using global.domain

  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302
      alb.ingress.kubernetes.io/healthcheck-path: /health
