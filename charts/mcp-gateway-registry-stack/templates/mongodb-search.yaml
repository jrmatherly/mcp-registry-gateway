{{- if and .Values.mongodb.enabled (.Values.mongodb.vectorSearch.enabled | default true) }}
# MongoDBSearch CRD deploys mongot pods for native $vectorSearch support
# Required for MongoDB CE 8.2+ vector search capabilities
apiVersion: mongodb.com/v1
kind: MongoDBSearch
metadata:
  name: {{ .Values.mongodb.name | default "mongodb" }}-search
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mcp-registry-gateway-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: mongodb-search
spec:
  # Reference to the MongoDB replica set
  mongoDBResourceRef:
    name: {{ .Values.mongodb.name | default "mongodb" }}

  # Resource requirements for mongot pods
  # Memory sizing: (num_vectors * dimensions * 4 bytes) * 1.25 buffer
  # Example: 100k docs with 384-dim embeddings = ~180MB minimum
  resourceRequirements:
    {{- if .Values.mongodb.vectorSearch.resources }}
    {{- toYaml .Values.mongodb.vectorSearch.resources | nindent 4 }}
    {{- else }}
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "8Gi"
    {{- end }}

  # Persistence for mongot index data
  {{- if .Values.mongodb.vectorSearch.persistence.enabled | default true }}
  persistence:
    single:
      storage: {{ .Values.mongodb.vectorSearch.persistence.size | default "20Gi" }}
      {{- if .Values.mongodb.vectorSearch.persistence.storageClass }}
      storageClass: {{ .Values.mongodb.vectorSearch.persistence.storageClass }}
      {{- end }}
  {{- end }}

  # Pod template customization
  podSpec:
    podTemplate:
      spec:
        {{- if .Values.mongodb.vectorSearch.affinity }}
        affinity:
          {{- toYaml .Values.mongodb.vectorSearch.affinity | nindent 10 }}
        {{- else }}
        # Default pod anti-affinity for HA
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: {{ .Values.mongodb.name | default "mongodb" }}-search
                  topologyKey: kubernetes.io/hostname
        {{- end }}
        {{- if .Values.mongodb.vectorSearch.nodeSelector }}
        nodeSelector:
          {{- toYaml .Values.mongodb.vectorSearch.nodeSelector | nindent 10 }}
        {{- end }}
        {{- if .Values.mongodb.vectorSearch.tolerations }}
        tolerations:
          {{- toYaml .Values.mongodb.vectorSearch.tolerations | nindent 10 }}
        {{- end }}
{{- end }}
