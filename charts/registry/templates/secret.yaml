apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.app.envSecretName }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "registry.labels" . | nindent 4 }}
data:
  ADMIN_PASSWORD: {{ randAlphaNum 64 | b64enc | quote }}
  AUTH_PROVIDER: {{ print "keycloak" | b64enc | quote }}
  AUTH_SERVER_EXTERNAL_URL: {{ printf "https://auth-server.%s" (.Values.global.domain | default "localhost:8888") | b64enc | quote }}
  AUTH_SERVER_URL: {{ printf "http://auth-server.%s.svc.cluster.local:8888" .Release.Namespace | b64enc | quote }}
  KEYCLOAK_URL: {{ printf "http://%s-keycloak-headless.%s.svc.cluster.local:8080" .Release.Name .Release.Namespace | b64enc | quote }}
  SECRET_KEY: {{ (.Values.global.secretKey | default .Values.app.secretKey | default (randAlphaNum 32)) | b64enc | quote }}
  GATEWAY_ADDITIONAL_SERVER_NAMES: {{ printf "mcpregistry.%s" .Values.global.domain | b64enc | quote }}
  # Storage backend configuration
  STORAGE_BACKEND: {{ (.Values.storage.backend | default "mongodb") | b64enc | quote }}
  # MongoDB/DocumentDB settings
  DOCUMENTDB_HOST: {{ (.Values.storage.mongodb.host | default "mongodb") | b64enc | quote }}
  DOCUMENTDB_PORT: {{ (.Values.storage.mongodb.port | default 27017) | toString | b64enc | quote }}
  DOCUMENTDB_DATABASE: {{ (.Values.storage.mongodb.database | default "mcp_registry") | b64enc | quote }}
  # MongoDB credentials - set username if provided
  {{- if .Values.storage.mongodb.username }}
  DOCUMENTDB_USERNAME: {{ .Values.storage.mongodb.username | b64enc | quote }}
  {{- end }}
  # Password can come from direct value or reference parent chart's mongodb config
  {{- if .Values.storage.mongodb.password }}
  DOCUMENTDB_PASSWORD: {{ .Values.storage.mongodb.password | b64enc | quote }}
  {{- end }}
  DOCUMENTDB_USE_TLS: {{ (.Values.storage.mongodb.useTls | default false) | toString | b64enc | quote }}
  DOCUMENTDB_DIRECT_CONNECTION: {{ (.Values.storage.mongodb.directConnection | default false) | toString | b64enc | quote }}
  DOCUMENTDB_NAMESPACE: {{ (.Values.storage.mongodb.namespace | default "default") | b64enc | quote }}
  # MongoDB CE 8.2+ vector search settings
  MONGODB_CE_82_NATIVE_SEARCH: {{ (.Values.storage.vectorSearch.enabled | default true) | toString | b64enc | quote }}
  MONGODB_VECTOR_INDEX_NAME: {{ (.Values.storage.vectorSearch.indexName | default "vector_index") | b64enc | quote }}
  MONGODB_VECTOR_SIMILARITY_METRIC: {{ (.Values.storage.vectorSearch.similarityMetric | default "cosine") | b64enc | quote }}
  MONGODB_VECTOR_NUM_CANDIDATES_MULTIPLIER: {{ (.Values.storage.vectorSearch.numCandidatesMultiplier | default 10) | toString | b64enc | quote }}
