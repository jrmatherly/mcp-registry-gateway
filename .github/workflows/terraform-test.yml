name: Terraform Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-test.yml"
  pull_request:
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-test.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: "Terraform Validate"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: terraform/aws-ecs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform fmt check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform init
        id: init
        run: terraform init -backend=false

      - name: Terraform validate
        id: validate
        run: terraform validate
        continue-on-error: true

      - name: Post validation results
        run: |
          echo "## Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY

  tflint:
    name: "TFLint"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: terraform/aws-ecs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.0

      - name: Init TFLint
        run: tflint --init
        continue-on-error: true

      - name: Run TFLint
        run: tflint --recursive --format compact
        continue-on-error: true

  tfsec:
    name: "TFSec Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --version

      - name: Run tfsec
        run: |
          tfsec terraform/aws-ecs --format=sarif --out=tfsec-results.sarif --soft-fail || true
        continue-on-error: true

      - name: Fix SARIF for upload
        if: always()
        run: |
          if [ -f "tfsec-results.sarif" ] && [ -s "tfsec-results.sarif" ]; then
            echo "Processing SARIF file to remove external module references..."
            # Use Python to filter out results from external modules (git::https:// URIs)
            # GitHub Code Scanning only accepts file:// or relative path URIs
            python3 << 'PYEOF'
          import json
          import sys

          with open('tfsec-results.sarif', 'r') as f:
              sarif = json.load(f)

          for run in sarif.get('runs', []):
              # Filter results to only include local files (not git:: external modules)
              original_results = run.get('results', [])
              filtered_results = []
              for result in original_results:
                  locations = result.get('locations', [])
                  # Check if any location references an external module
                  is_external = False
                  for loc in locations:
                      uri = loc.get('physicalLocation', {}).get('artifactLocation', {}).get('uri', '')
                      if uri.startswith('git::') or uri.startswith('git://'):
                          is_external = True
                          break
                  if not is_external:
                      filtered_results.append(result)

              removed_count = len(original_results) - len(filtered_results)
              if removed_count > 0:
                  print(f"Filtered out {removed_count} results from external modules")
              run['results'] = filtered_results

          with open('tfsec-results.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)

          print(f"SARIF file ready with {sum(len(r.get('results', [])) for r in sarif.get('runs', []))} results")
          PYEOF
          else
            echo "Creating valid empty SARIF file"
            cat > tfsec-results.sarif << 'SARIF_EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "tfsec",
                    "version": "1.0.0",
                    "informationUri": "https://github.com/aquasecurity/tfsec"
                  }
                },
                "results": []
              }
            ]
          }
          SARIF_EOF
          fi
          echo "SARIF file preview:"
          head -30 tfsec-results.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

  checkov:
    name: "Checkov Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/aws-ecs
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          download_external_modules: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  summary:
    name: "Terraform Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, tflint, tfsec, checkov]
    if: always()

    steps:
      - name: Results Summary
        run: |
          echo "## Terraform Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFSec | ${{ needs.tfsec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov.result }} |" >> $GITHUB_STEP_SUMMARY
