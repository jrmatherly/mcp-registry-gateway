name: Terraform Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-test.yml"
  pull_request:
    paths:
      - "terraform/**"
      - ".github/workflows/terraform-test.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: "Terraform Validate"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: terraform/aws-ecs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform fmt check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform init
        id: init
        run: terraform init -backend=false

      - name: Terraform validate
        id: validate
        run: terraform validate
        continue-on-error: true

      - name: Post validation results
        run: |
          echo "## Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY

  tflint:
    name: "TFLint"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: terraform/aws-ecs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.0

      - name: Init TFLint
        run: tflint --init
        continue-on-error: true

      - name: Run TFLint
        run: tflint --recursive --format compact
        continue-on-error: true

  tfsec:
    name: "TFSec Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform/aws-ecs
          soft_fail: true
          format: sarif
          additional_args: --out ${{ github.workspace }}/tfsec-results.sarif
        continue-on-error: true

      - name: Fix SARIF URI scheme
        if: always()
        run: |
          if [ -f "${{ github.workspace }}/tfsec-results.sarif" ]; then
            # Fix git:// URI scheme to file:// for GitHub Code Scanning compatibility
            sed -i 's|"uri": "git://|"uri": "file://|g' "${{ github.workspace }}/tfsec-results.sarif"
            echo "Fixed SARIF URI scheme"
          else
            echo "No SARIF file found, creating empty one"
            echo '{"version":"2.1.0","runs":[]}' > "${{ github.workspace }}/tfsec-results.sarif"
          fi

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ github.workspace }}/tfsec-results.sarif
        continue-on-error: true

  checkov:
    name: "Checkov Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/aws-ecs
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          download_external_modules: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  summary:
    name: "Terraform Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, tflint, tfsec, checkov]
    if: always()

    steps:
      - name: Results Summary
        run: |
          echo "## Terraform Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFSec | ${{ needs.tfsec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov.result }} |" >> $GITHUB_STEP_SUMMARY
