name: Helm Chart Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "charts/**"
      - ".github/workflows/helm-test.yml"
  pull_request:
    paths:
      - "charts/**"
      - ".github/workflows/helm-test.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: "Helm Lint"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami || true
          helm repo update

      - name: Build chart dependencies
        run: |
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              echo "Building dependencies for ${chart}..."
              helm dependency build "$chart" || true
            fi
          done

      - name: Lint all charts
        run: |
          echo "## Helm Lint Results" >> $GITHUB_STEP_SUMMARY
          failed=0
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              echo "Linting ${chart}..."
              if helm lint "$chart" 2>&1; then
                echo "- ${chart}: PASSED" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ${chart}: WARNING (lint issues found)" >> $GITHUB_STEP_SUMMARY
                # Don't fail on lint warnings, only errors
              fi
            fi
          done

  template:
    name: "Helm Template Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Template validation
        run: |
          echo "## Helm Template Results" >> $GITHUB_STEP_SUMMARY
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              echo "Validating template for ${chart}..."
              if helm template test "$chart" --debug > /dev/null 2>&1; then
                echo "- ${chart}: PASSED" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ${chart}: FAILED" >> $GITHUB_STEP_SUMMARY
                helm template test "$chart" --debug || true
              fi
            fi
          done

  kubeconform:
    name: "Kubernetes Manifest Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          echo "## Kubeconform Results" >> $GITHUB_STEP_SUMMARY
          for chart in charts/*/; do
            if [ -f "${chart}Chart.yaml" ]; then
              echo "Validating ${chart}..."
              helm template test "$chart" 2>/dev/null | kubeconform -strict -summary -ignore-missing-schemas || true
            fi
          done

  dependency-check:
    name: "Helm Dependency Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami || true
          helm repo update

      - name: Build dependencies for umbrella chart
        run: |
          if [ -f "charts/mcp-gateway-registry-stack/Chart.yaml" ]; then
            echo "Building dependencies for umbrella chart..."
            helm dependency build charts/mcp-gateway-registry-stack || true
          fi

  summary:
    name: "Helm Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint, template, kubeconform, dependency-check]
    if: always()

    steps:
      - name: Results Summary
        run: |
          echo "## Helm Chart Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Template | ${{ needs.template.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubeconform | ${{ needs.kubeconform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
